# 📄 기능 명세서 (Feature Specification Document)

> 이 문서는 반복 일정 생성 기능에 대한 PRD 수준의 상세 기능 명세를 정의합니다.

---

## 1. 🌟 기능 개요 (Feature Overview)

### 1.1 기능명

**반복 일정 생성 및 수정 기능**

### 1.2 기능 목적

사용자가 일정을 생성하거나 수정할 때 반복 유형(매일/매주/매월/매년)을 선택하여, 지정된 종료일까지 자동으로 여러 개의 일정을 생성할 수 있도록 합니다. 이를 통해 정기적으로 발생하는 일정을 매번 수동으로 입력하는 번거로움을 제거하고 사용자 경험을 개선합니다.

### 1.3 기능 범위

**포함 범위:**
- 일정 생성/수정 시 반복 유형 선택 UI (이미 주석 처리되어 있음)
- 반복 유형별 일정 생성 로직 (매일/매주/매월/매년)
- 반복 간격 및 종료일 설정
- 예외 상황 처리 (31일 매월, 2월 29일 매년)
- 생성된 반복 일정의 캘린더/목록 표시
- 반복 일정 수정 시 기존 UI 활용

**포함하지 않는 범위:**
- 반복 일정과 기존 일정의 겹침(overlap) 검사 (요구사항에 명시됨)
- 반복 일정 시리즈 전체 수정/삭제 UI (향후 확장 가능)
- 복잡한 반복 패턴 (예: 매월 첫째 주 월요일)

### 1.4 주요 사용자 시나리오

1. **매일 반복 일정**: 사용자가 "매일 오전 10시 미팅"을 2025-11-01부터 2025-11-30까지 생성
2. **매주 반복 일정**: 사용자가 "매주 월요일 팀 회의"를 생성 (시작일의 요일 기준)
3. **매월 반복 일정**: 사용자가 "매월 15일 월급날"을 생성
4. **매년 반복 일정**: 사용자가 "생일 (3월 5일)"을 매년 반복 생성
5. **예외 처리**: 31일에 매월 반복 선택 시 31일이 없는 달은 자동으로 건너뜀

---

## 2. 🚀 상세 기능 명세 (Detailed Feature Specification)

### 2.1 반복 일정 생성 로직

#### 2.1.1 동작 흐름

1. 사용자가 일정 생성 폼에서 "반복 일정" 체크박스를 활성화
2. 반복 유형(매일/매주/매월/매년) 선택
3. 반복 간격(interval) 입력 (기본값: 1)
4. 반복 종료일(endDate) 선택
5. "일정 추가" 버튼 클릭
6. 시스템이 반복 유형에 따라 여러 개의 일정 객체 생성
7. 생성된 일정 배열을 `/api/events-list` 엔드포인트로 전송
8. 서버가 각 일정에 고유 ID 할당 및 동일한 `repeat.id` 부여
9. 캘린더와 일정 목록에 생성된 반복 일정 표시

#### 2.1.2 비즈니스 로직

**공통 로직:**
- 모든 반복 일정은 동일한 `repeat.id`를 공유하여 시리즈임을 표시
- 각 개별 일정은 고유한 `id`를 가짐
- 반복 종료일(`endDate`)이 시작일보다 이전이면 오류 처리
- 겹침 검사는 수행하지 않음 (요구사항)

**매일 반복 (daily):**
```
시작일: 2025-11-01
종료일: 2025-11-05
간격: 1

생성되는 일정:
- 2025-11-01
- 2025-11-02
- 2025-11-03
- 2025-11-04
- 2025-11-05
```

**매주 반복 (weekly):**
```
시작일: 2025-11-01 (금요일)
종료일: 2025-11-30
간격: 1

생성되는 일정:
- 2025-11-01 (금)
- 2025-11-08 (금)
- 2025-11-15 (금)
- 2025-11-22 (금)
- 2025-11-29 (금)
```

**매월 반복 (monthly):**
```
시작일: 2025-01-15
종료일: 2025-06-30
간격: 1

생성되는 일정:
- 2025-01-15
- 2025-02-15
- 2025-03-15
- 2025-04-15
- 2025-05-15
- 2025-06-15
```

**매년 반복 (yearly):**
```
시작일: 2025-03-05
종료일: 2028-12-31
간격: 1

생성되는 일정:
- 2025-03-05
- 2026-03-05
- 2027-03-05
- 2028-03-05
```

#### 2.1.3 UI/UX 고려사항

- 기존 App.tsx에 주석 처리된 UI 활용 (441-478줄)
- 반복 유형 선택 시 반복 간격 및 종료일 입력 필드 표시
- 반복 일정 생성 시 로딩 인디케이터 표시 (선택사항)
- 생성된 반복 일정은 일정 목록에서 반복 정보 표시
- 일정 수정 시 해당 일정의 반복 정보 자동 로드

### 2.2 예외 상황 처리

#### 2.2.1 31일 매월 반복

**시나리오:**
```
시작일: 2025-01-31
종료일: 2025-12-31
반복 유형: 매월
간격: 1

생성되는 일정:
- 2025-01-31 (31일 존재)
- 2025-03-31 (31일 존재, 2월 건너뜀)
- 2025-05-31 (31일 존재, 4월 건너뜀)
- 2025-07-31 (31일 존재, 6월 건너뜀)
- 2025-08-31 (31일 존재)
- 2025-10-31 (31일 존재, 9월 건너뜀)
- 2025-12-31 (31일 존재, 11월 건너뜀)
```

**로직:**
- 해당 월의 마지막 날짜를 확인
- 시작일의 day가 해당 월의 마지막 날짜보다 크면 건너뜀

#### 2.2.2 2월 29일 매년 반복

**시나리오:**
```
시작일: 2024-02-29 (윤년)
종료일: 2030-12-31
반복 유형: 매년
간격: 1

생성되는 일정:
- 2024-02-29 (윤년)
- 2028-02-29 (윤년, 2025/2026/2027 건너뜀)
```

**로직:**
- 윤년 판별 공식 적용 (date-fns 사용 금지)
  - 연도가 4로 나누어떨어지고
  - 100으로 나누어떨어지지 않거나
  - 400으로 나누어떨어지면 윤년
- 2월 29일이 아닌 경우는 매년 생성

### 2.3 반복 일정 수정

#### 2.3.1 단일 일정 수정

- 기존 단일 일정 수정 API (`PUT /api/events/:id`) 사용
- 해당 일정만 수정됨
- `repeat.id`는 유지되지만 다른 시리즈 일정은 영향받지 않음

#### 2.3.2 시리즈 전체 수정 (향후 확장)

- 서버에 이미 구현된 `PUT /api/recurring-events/:repeatId` 활용 가능
- 현재 단계에서는 UI 구현하지 않음

---

## 3. 📥 입력/출력 정의 (Input/Output Definition)

### 3.1 반복 일정 생성 함수

#### 3.1.1 입력 (Input)

| 필드명        | 타입         | 필수 여부 | 설명                                    | 예시 값              |
| :------------ | :----------- | :-------- | :-------------------------------------- | :------------------- |
| `eventData`   | `EventForm`  | `Y`       | 사용자가 입력한 일정 데이터             | -                    |
| `title`       | `string`     | `Y`       | 일정 제목                               | `"팀 회의"`          |
| `date`        | `string`     | `Y`       | 시작일 (YYYY-MM-DD)                     | `"2025-11-01"`       |
| `startTime`   | `string`     | `Y`       | 시작 시간 (HH:mm)                       | `"10:00"`            |
| `endTime`     | `string`     | `Y`       | 종료 시간 (HH:mm)                       | `"11:00"`            |
| `description` | `string`     | `N`       | 일정 설명                               | `"주간 팀 회의"`     |
| `location`    | `string`     | `N`       | 장소                                    | `"회의실 A"`         |
| `category`    | `string`     | `Y`       | 카테고리                                | `"업무"`             |
| `repeat`      | `RepeatInfo` | `Y`       | 반복 정보                               | -                    |
| `repeat.type` | `RepeatType` | `Y`       | 반복 유형                               | `"weekly"`           |
| `repeat.interval` | `number` | `Y`       | 반복 간격                               | `1`                  |
| `repeat.endDate` | `string`  | `N`       | 반복 종료일 (YYYY-MM-DD)                | `"2025-12-31"`       |
| `notificationTime` | `number` | `Y`      | 알림 시간 (분 단위)                     | `10`                 |

#### 3.1.2 출력 (Output)

| 필드명   | 타입      | 설명                                   | 예시 값                  |
| :------- | :-------- | :------------------------------------- | :----------------------- |
| `events` | `Event[]` | 생성된 반복 일정 배열                  | `[{...}, {...}, {...}]`  |
| `[].id`  | `string`  | 각 일정의 고유 ID (서버 생성)          | `"uuid-1234-5678"`       |
| `[].repeat.id` | `string` | 반복 시리즈 ID (같은 값)        | `"repeat-uuid-abcd"`     |

### 3.2 API 엔드포인트

#### 3.2.1 반복 일정 생성 API

**엔드포인트:** `POST /api/events-list`

**요청 Body:**
```typescript
{
  events: EventForm[] // repeat.id는 없음 (서버가 생성)
}
```

**응답:**
```typescript
{
  events: Event[] // 각각 id와 repeat.id가 할당됨
}
```

**서버 로직 (server.js 76-99줄):**
- 공통 `repeatId` 생성
- 각 이벤트에 고유 `id` 할당
- `repeat.type`이 'none'이 아니면 `repeat.id`에 `repeatId` 할당
- DB에 저장 후 생성된 이벤트 배열 반환

---

## 4. ⚠️ 예외 처리 (Error Handling)

### 4.1 반복 종료일이 시작일보다 이전

- **발생 조건**: `repeat.endDate` < `date`
- **오류 메시지**: "반복 종료일은 시작일 이후여야 합니다."
- **시스템 동작**: 일정 생성 중단, 사용자에게 알림 표시
- **복구 전략**: 사용자가 종료일을 수정

### 4.2 반복 종료일 미입력

- **발생 조건**: `repeat.type` !== 'none' && !`repeat.endDate`
- **오류 메시지**: "반복 일정은 종료일을 입력해야 합니다."
- **시스템 동작**: 일정 생성 중단
- **복구 전략**: 사용자가 종료일 입력

### 4.3 반복 간격이 0 이하

- **발생 조건**: `repeat.interval` <= 0
- **오류 메시지**: "반복 간격은 1 이상이어야 합니다."
- **시스템 동작**: 기본값 1로 설정 또는 생성 중단
- **복구 전략**: 사용자가 간격 수정

### 4.4 API 호출 실패

- **발생 조건**: `/api/events-list` 호출 시 네트워크 오류 또는 서버 에러
- **오류 메시지**: "일정 저장 실패"
- **시스템 동작**: 사용자에게 에러 스낵바 표시, 이벤트 목록 갱신 안 함
- **복구 전략**: 사용자가 재시도

### 4.5 생성된 반복 일정이 없음

- **발생 조건**: 예외 상황으로 인해 생성된 일정이 0개 (예: 31일 매월 반복인데 종료일까지 31일이 없는 달만 있음)
- **오류 메시지**: "생성 가능한 반복 일정이 없습니다."
- **시스템 동작**: 일정 생성 중단, 사용자에게 알림
- **복구 전략**: 사용자가 시작일 또는 반복 유형 변경

---

## 5. 📊 영향 분석 (Impact Analysis)

### 5.1 기존 시스템 영향

**수정이 필요한 파일:**

1. **`src/types.ts`**
   - `RepeatInfo` 인터페이스에 `id?: string` 필드 추가
   - 기존: `{ type, interval, endDate }`
   - 변경: `{ type, interval, endDate, id? }`

2. **`src/utils/recurringEvents.ts` (신규 생성)**
   - `generateRecurringEvents(eventData: EventForm): EventForm[]`
   - `generateDailyEvents(...)`
   - `generateWeeklyEvents(...)`
   - `generateMonthlyEvents(...)`
   - `generateYearlyEvents(...)`
   - `isLeapYear(year: number): boolean`
   - `getDaysInMonth(year: number, month: number): number`

3. **`src/hooks/useEventOperations.ts`**
   - `saveEvent` 함수 수정
   - 반복 일정일 경우 `/api/events-list` 엔드포인트 호출
   - 단일 일정일 경우 기존 로직 유지

4. **`src/App.tsx`**
   - 441-478줄 주석 해제
   - `setRepeatType`, `setRepeatInterval`, `setRepeatEndDate` 주석 해제 (80-84줄)
   - 반복 일정 UI 활성화

**영향받지만 수정 불필요:**

- `src/hooks/useEventForm.ts`: 이미 반복 일정 상태 관리 구현됨
- `server.js`: 이미 `/api/events-list` 엔드포인트 구현됨
- `src/utils/dateUtils.ts`: 기존 날짜 유틸 재사용 가능

### 5.2 새로운 의존성 (최소화 방안)

**외부 라이브러리:**
- ❌ 없음 (date-fns 사용 금지)

**내부 모듈:**
- ✅ 순수 JavaScript Date API만 사용
- ✅ 기존 `dateUtils.ts`의 함수 재사용

**최소화 방안:**
- 날짜 계산은 모두 순수 JavaScript로 구현
- 윤년 판별, 월별 일수 계산 등 유틸 함수 직접 구현
- 기존 타입 시스템 최대한 활용

### 5.3 성능/보안/확장성 고려사항

**성능:**
- 반복 일정 생성 시 최대 생성 개수 제한 필요 (예: 1000개)
- 너무 긴 기간의 매일 반복 선택 시 성능 이슈 가능
- 해결: 종료일이 시작일로부터 3년 이내로 제한 (선택사항)

**보안:**
- 클라이언트 입력값 검증 필수
- 서버에서도 입력값 재검증 (이미 구현됨)
- SQL Injection 등의 위험은 현재 JSON 파일 DB 사용으로 해당 없음

**확장성:**
- 향후 복잡한 반복 패턴 추가 가능 (예: 매월 첫째 주 월요일)
- 반복 시리즈 전체 수정/삭제 UI 추가 가능 (서버 이미 준비됨)
- 예외 날짜 지정 기능 추가 가능 (특정 날짜 제외)

---

## 6. 🧪 테스트 고려사항 (Test Considerations)

### 주요 테스트 시나리오

**단위 테스트 (유틸 함수):**
1. `generateDailyEvents`: 매일 반복 일정 생성
2. `generateWeeklyEvents`: 매주 반복 일정 생성 (요일 유지)
3. `generateMonthlyEvents`: 매월 반복 일정 생성
4. `generateYearlyEvents`: 매년 반복 일정 생성
5. `isLeapYear`: 윤년 판별
6. `getDaysInMonth`: 월별 일수 계산

**통합 테스트 (hooks):**
1. `useEventOperations.saveEvent`: 반복 일정 저장 API 호출
2. 반복 일정 생성 후 이벤트 목록 갱신
3. 반복 일정 수정 시 단일 일정만 수정

**UI 테스트:**
1. 반복 일정 체크박스 활성화 시 추가 필드 표시
2. 반복 유형 선택 시 UI 업데이트
3. 생성된 반복 일정 캘린더 표시
4. 생성된 반복 일정 목록 표시

### 엣지 케이스

1. **31일 매월 반복**: 31일이 없는 달 건너뛰기
2. **2월 29일 매년 반복**: 윤년만 생성
3. **2월 30일/31일 매월 반복**: 2월은 항상 건너뛰기
4. **반복 종료일 = 시작일**: 1개의 일정만 생성
5. **매우 짧은 반복 간격**: interval = 1로 정상 동작
6. **매우 긴 반복 기간**: 3년 이상 매일 반복 (성능 고려)
7. **윤년 경계**: 2024-02-29, 2025-02-28, 2028-02-29
8. **연말/연초 경계**: 12월 31일부터 매주/매월 반복
9. **빈 종료일**: 반복 일정인데 종료일 없음 → 에러
10. **과거 종료일**: 종료일이 시작일보다 이전 → 에러

### 성능 테스트 요구사항

- 1000개 이상의 반복 일정 생성 시도 → 제한 또는 경고
- 매일 반복 3년 생성 시 응답 시간 측정
- 반복 일정 생성 후 캘린더 렌더링 시간 측정

### 보안 테스트 요구사항

- 반복 간격에 음수 입력 시도
- 반복 종료일에 잘못된 형식 입력 시도
- 매우 큰 숫자의 반복 간격 입력 시도

---

## 7. 📚 관련 문서 및 참조

- **`agents_spec.md`**: 시스템 전체 명세
- **`server.js`**: 백엔드 API 명세
  - 76-99줄: POST /api/events-list (반복 일정 생성)
  - 101-126줄: PUT /api/events-list (여러 일정 수정)
  - 142-174줄: PUT /api/recurring-events/:repeatId (시리즈 전체 수정)
  - 176-192줄: DELETE /api/recurring-events/:repeatId (시리즈 전체 삭제)
- **`src/types.ts`**: 타입 정의
- **`src/App.tsx`**: 441-478줄 반복 일정 UI
- **`src/hooks/useEventForm.ts`**: 반복 일정 상태 관리

---

## 📝 변경 이력

| 버전 | 날짜       | 변경 내용       | 작성자 |
| :--- | :--------- | :-------------- | :----- |
| 1.0  | 2025-10-31 | 최초 작성       | Athena |

